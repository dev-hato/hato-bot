---
name: pr-copy-ci-hato-bot

on:
  push:
    branches:
      - develop

jobs:
  # CIの差分をsudden-deathにpushする
  pr-copy-ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3.1.0
        with:
          fetch-depth: 0
          path: hato-bot
      - name: Set org name
        uses: actions/github-script@v6.3.3
        id: set_org_name
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          result-encoding: string
          script: |
            const script = require(`${process.env.GITHUB_WORKSPACE}/hato-bot/scripts/pr_copy_ci_hato_bot/pr_copy_ci/copy_package.js`)
            return script()
      - uses: actions/checkout@v3.1.0
        with:
          fetch-depth: 0
          repository: ${{steps.set_org_name.outputs.result}}/sudden-death
          path: sudden-death
      - name: Copy CI
        run: bash "${GITHUB_WORKSPACE}/hato-bot/scripts/pr_copy_ci_hato_bot/pr_copy_ci/copy_ci.sh"
      - name: Show diff
        id: show_diff
        working-directory: sudden-death
        run: bash "${GITHUB_WORKSPACE}/hato-bot/scripts/pr_copy_ci_hato_bot/pr_copy_ci/show_diff.sh"
      - name: Push
        if: ${{ steps.show_diff.outputs.diff != '' }}
        working-directory: sudden-death
        env:
          SUDDEN_DEATH_CI_PRIVATE_KEY: ${{secrets.SUDDEN_DEATH_CI_PRIVATE_KEY}}
          ORG_NAME: ${{steps.set_org_name.outputs.result}}
        run: bash "${GITHUB_WORKSPACE}/hato-bot/scripts/pr_copy_ci_hato_bot/pr_copy_ci/push.sh"

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true
